<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Sustainable Neighborhood</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  />
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: #f5f7f9;
      color: #333;
    }
    header {
      background: #2a9d8f;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    header nav a {
      color: white;
      margin-left: 1rem;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s;
    }
    header nav a:hover {
      color: #e9f5f2;
    }
    .hero {
      text-align: center;
      padding: 3rem 1rem;
      background: linear-gradient(to right, #b2dfdb, #e0f2f1);
      animation: fadeIn 1s ease;
    }
    .hero h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    .hero p {
      margin-bottom: 1rem;
    }
    .hero button {
      background: #2a9d8f;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      margin: 0 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    .hero button:hover {
      background: #21867a;
    }
    .main {
      display: flex;
      flex-wrap: wrap;
      padding: 2rem;
      gap: 2rem;
    }
    .form-container,
    .map-container {
      flex: 1 1 400px;
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      transition: transform 0.2s;
    }
    .form-container:hover,
    .map-container:hover {
      transform: translateY(-2px);
    }
    .form-container input,
    .form-container textarea {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .form-container button {
      width: 100%;
      padding: 0.75rem;
      background: #2a9d8f;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    .form-container button:hover {
      background: #21867a;
    }
    .recent-reports {
      padding: 2rem;
    }
    .report-card {
      background: white;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .report-card i {
      font-size: 1.5rem;
      color: #2a9d8f;
    }
    /* Map styles */
    #map {
      width: 100%;
      height: 300px;
      border-radius: 8px;
      display: none; /* initially hidden */
    }
    #map.visible {
      display: block;
      animation: fadeIn 0.5s ease forwards;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }




    .comment-section input {
  padding: 0.5rem;
  border-radius: 4px;
  border: 1px solid #ccc;
}
.comment-section button {
  padding: 0.5rem 1rem;
  background: #2a9d8f;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-left: 5px;
}
.comment-section button:hover {
  background: #21867a;
}

  </style>
</head>
<body>
  <script>
  // Redirect if no registered user
  const user = localStorage.getItem("user");
  if (!user) {
    window.location.href = "register.html";
  }

  const userObj = JSON.parse(localStorage.getItem("user"));
  document.getElementById("userNameDisplay").textContent = "Hello, " + userObj.name;

  function logout() {
    localStorage.removeItem("user");
    window.location.href = "register.html";
  }
</script>

  <header>
    <h2><i class="fas fa-leaf"></i> My Sustainable Neighborhood</h2>
    <nav>
      <a href="#">Home</a>
      <a href="#">Report</a>
      <a href="#">Map</a>
      <a href="#">About</a>
      <a href="#">Contact</a>
      <span id="userNameDisplay" style="margin-left:1rem; font-weight:bold;"></span>
      <a href="#" onclick="logout()" style="color:yellow;">(Logout)</a>
    </nav>
  </header>
  <section class="hero">
    <h1>Share Sustainability Issues in Your Neighborhood, Make a Difference!</h1>
    <p>No recycling bin? Water wastage? Report it now!</p>
    <button id="btnShowForm">Report Issue</button>
    <button id="btnShowMap">View Map</button>
  </section>
  <section class="main">
    <div class="form-container" id="formContainer" style="display:none;">
      <h3><i class="fas fa-exclamation-circle"></i> Report an Issue</h3>
      <input type="text" id="issueTitle" placeholder="Issue Title" />
      <textarea
        id="issueDescription"
        rows="4"
        placeholder="Brief description of the issue..."
      ></textarea>
      <input type="text" id="issueLocation" placeholder="Location (lat,lng)" />
      <button id="submitBtn"><i class="fas fa-paper-plane"></i> Submit</button>
    </div>
    <div class="map-container">
      <h3><i class="fas fa-map-marked-alt"></i> Map View</h3>
      <div id="map"></div>
    </div>
  </section>
  <section class="recent-reports">
    <h3>Recent Reports</h3>
    <div id="reportsList">
      <!-- Reports will load here -->
    </div>
  </section>


<!-- Firebase App (the core Firebase SDK) -->
<script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore-compat.js"></script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBcxJ02USHu9YDp66i9FVvjsX-0YzbQkHA",
    authDomain: "sustainable-neighborhood-web.firebaseapp.com",
    projectId: "sustainable-neighborhood-web",
    storageBucket: "sustainable-neighborhood-web.firebasestorage.app",
    messagingSenderId: "773604092133",
    appId: "1:773604092133:web:a5346a4fdb4298b9d58c0c",
    measurementId: "G-P7XJFESV08"
  };

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const analytics = firebase.analytics(app);
  const db = firebase.firestore(app);

  // Elements
  const btnShowForm = document.getElementById('btnShowForm');
  const btnShowMap = document.getElementById('btnShowMap');
  const formContainer = document.getElementById('formContainer');
  const mapDiv = document.getElementById('map');
  const submitBtn = document.getElementById('submitBtn');
  const reportsList = document.getElementById('reportsList');

  // Initialize Leaflet map
  let map = L.map('map').setView([44.4268, 26.1025], 13); // Bucharest coords as default

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  }).addTo(map);

  // Store markers globally so we can remove them later
  window.reportMarkers = [];

  // Show/hide form
  btnShowForm.addEventListener('click', () => {
    if (formContainer.style.display === 'none') {
      formContainer.style.display = 'block';
      mapDiv.classList.remove('visible');
    } else {
      formContainer.style.display = 'none';
    }
  });
  // Autofill coordinates from address using Nominatim API
  document.getElementById('issueLocation').addEventListener('blur', async function () {
    const value = this.value.trim();
    // If already in lat,lng format, skip
    if (/^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/.test(value)) return;

    // Query Nominatim for geocoding
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(value)}`;
    try {
      const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
      const data = await res.json();
      if (data && data.length > 0) {
        const lat = data[0].lat;
        const lon = data[0].lon;
        this.value = `${lat},${lon}`;
        // Optionally, show marker on map
        map.setView([lat, lon], 16);
        // Temporary marker for preview
        if (window.tempMarker) map.removeLayer(window.tempMarker);
        window.tempMarker = L.marker([lat, lon]).addTo(map)
          .bindPopup('Selected Location').openPopup();
      }
    } catch (e) {
      // Ignore errors silently
    }
  });
  // Show/hide map
  btnShowMap.addEventListener('click', () => {
    if (mapDiv.classList.contains('visible')) {
      mapDiv.classList.remove('visible');
    } else {
      mapDiv.classList.add('visible');
      formContainer.style.display = 'none';
      map.invalidateSize(); // Fix map display after visibility toggle
    }
  });

  // Escape HTML helper
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Choose icon based on title keywords
  function getIcon(title) {
    const t = title.toLowerCase();
    if (t.includes('plastic') || t.includes('waste')) return 'fa-recycle';
    if (t.includes('water') || t.includes('leak')) return 'fa-tint';
    if (t.includes('tree') || t.includes('park')) return 'fa-tree';
    return 'fa-exclamation-circle';
  }

  // Load and display reports
  function loadReports() {
    reportsList.innerHTML = '';
    db.collection('reports').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
      reportsList.innerHTML = '';
      window.reportMarkers.forEach(m => map.removeLayer(m));
      window.reportMarkers = [];

      snapshot.forEach((doc) => {
        const report = doc.data();
        const icon = getIcon(report.title);
        const reportId = doc.id;
        const div = document.createElement('div');
        div.className = 'report-card';
        // ...existing code inside loadReports()...
    div.innerHTML = `
      <i class="fas ${icon}"></i>
      <div>
        <strong>${escapeHtml(report.title)}</strong>
        <p>${escapeHtml(report.description)}</p>
        <small><em>Location: ${escapeHtml(report.location)}</em></small>
        <button onclick="deleteReport('${reportId}')" style="color:red; margin-top:5px;">Delete Report</button>
        <div class="comment-section" style="margin-top:10px;">
          <div class="comments" id="comments-${reportId}"></div>
          <input type="text" id="comment-input-${reportId}" placeholder="Add a comment..." style="margin-top:5px; width: 80%;" />
          <button onclick="addComment('${reportId}')" style="margin-top:5px;">Post</button>
        </div>
      </div>
    `;
        reportsList.appendChild(div);

        const coords = report.location.split(',');
        if (coords.length === 2) {
          const lat = parseFloat(coords[0].trim());
          const lng = parseFloat(coords[1].trim());
          if (!isNaN(lat) && !isNaN(lng)) {
            const marker = L.marker([lat, lng]).addTo(map)
              .bindPopup(`<b>${escapeHtml(report.title)}</b><br>${escapeHtml(report.description)}`);
            window.reportMarkers.push(marker);
          }
        }

        // Load comments for this report
        db.collection('reports')
          .doc(reportId)
          .collection('comments')
          .orderBy('createdAt', 'asc')
          .onSnapshot((commentSnapshot) => {
            const commentDiv = document.getElementById(`comments-${reportId}`);
            if (commentDiv) {
              commentDiv.innerHTML = '';
              commentSnapshot.forEach((c) => {
                const data = c.data();
                const commentText = escapeHtml(data.text);
                const commentUser = escapeHtml(data.user || 'Anonymous');
                              
                const commentId = c.id;
                commentDiv.innerHTML += `
                  <p style="margin:2px 0;">
                    <strong>${commentUser}:</strong> ${commentText}
                    <button onclick="deleteComment('${reportId}', '${commentId}')">Delete</button>
                  </p>
                `;
              });
            }
          });
        });
      });
    }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function getIcon(title) {
    const t = title.toLowerCase();
    if (t.includes('plastic') || t.includes('waste')) return 'fa-recycle';
    if (t.includes('water') || t.includes('leak')) return 'fa-tint';
    if (t.includes('tree') || t.includes('park')) return 'fa-tree';
    return 'fa-exclamation-circle';
  }

  function addComment(reportId) {
    const input = document.getElementById(`comment-input-${reportId}`);
    const text = input.value.trim();
    if (!text) return;

    db.collection('reports')
      .doc(reportId)
      .collection('comments')
      .add({
        text,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        user: userObj.name || "Anonymous"
      })
      .then(() => {
        input.value = '';
      })
      .catch((e) => alert('Error adding comment: ' + e.message));
  }

  

function deleteReport(reportId) {
  if (confirm('Are you sure you want to delete this report?')) {
    // Delete all comments under this report first
    db.collection('reports')
      .doc(reportId).collection('comments').get().then(snapshot => {
        const batch = db.batch();
        snapshot.forEach(doc => {
          batch.delete(doc.ref);
        });
        return batch.commit();
      }).then(() => {
        // Delete the report itself
        return db.collection('reports').doc(reportId).delete();
      }).catch(e => alert('Error deleting report: ' + e.message));
  }
}

function deleteComment(reportId, commentId) {
  if (confirm('Delete this comment?')) {
    db.collection('reports')
      .doc(reportId)
      .collection('comments')
      .doc(commentId)
      .delete()
      .catch(e => alert('Error deleting comment: ' + e.message));
  }
}

  // Submit form
  submitBtn.addEventListener('click', async () => {
    const title = document.getElementById('issueTitle').value.trim();
    const description = document.getElementById('issueDescription').value.trim();
    const location = document.getElementById('issueLocation').value.trim();

    if (!title || !description || !location) {
      alert('Please fill all fields.');
      return;
    }

    try {
      await db.collection('reports').add({
        title,
        description,
        location,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } catch (e) {
      alert('Error saving report: ' + e.message);
      return;
    }

    document.getElementById('issueTitle').value = '';
    document.getElementById('issueDescription').value = '';
    document.getElementById('issueLocation').value = '';
    formContainer.style.display = 'none';
    alert('Thank you for your report!');
  });




  loadReports();


</script>
</body>
</html>
    
